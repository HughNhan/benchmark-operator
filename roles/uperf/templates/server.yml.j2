---
kind: Job
apiVersion: batch/v1
metadata:

{% if workload_args.max_node is not defined %}
  name: 'uperf-server-{{ item }}-{{ trunc_uuid }}'
{% else %}
  name: 'uperf-server-{{worker_node_list[ item[0]] }}-{{ item[1] }}-{{ trunc_uuid }}'
{% endif %}

  namespace: "{{ operator_namespace }}"
spec:
  ttlSecondsAfterFinished: 600
  backoffLimit: 0
  template:
    metadata:
      labels:

{% if workload_args.max_node is not defined %}
        app: uperf-bench-server-{{item}}-{{ trunc_uuid }}
{% else %}
        #app: uperf-bench-server-{{ item[0] }}-{{ item[1]  }}-{{ trunc_uuid }}
        app: uperf-bench-server-{{ worker_node_list[item[0]] }}-{{ item[1]  }}-{{ trunc_uuid }}
{% endif %}

        type: uperf-bench-server-{{ trunc_uuid }}
      annotations:
{% if workload_args.multus.enabled is sameas true %}
        k8s.v1.cni.cncf.io/networks: {{ workload_args.multus.server}}
{% endif %}
        node_idx: '{{ item[0] }}'
    spec:
{% if workload_args.runtime_class is defined %}
      runtimeClassName: "{{ workload_args.runtime_class }}"
{% endif %}
{% if workload_args.hostnetwork is sameas true %}
      hostNetwork: true
      serviceAccountName: benchmark-operator
{% endif %}
      containers:
      - name: benchmark
        image: {{ workload_args.image | default('quay.io/cloud-bulldozer/uperf:latest') }}
{% if workload_args.server_resources is defined %}
        resources: {{ workload_args.server_resources | to_json }}
{% endif %}
        imagePullPolicy: Always
        command: ["/bin/sh","-c"]
        args: ["uperf -s -v -P 20000"]
      restartPolicy: OnFailure
{% if workload_args.pin is sameas true %}
      nodeSelector:
        kubernetes.io/hostname: '{{ workload_args.pin_server }}'
{% endif %}

# 
# V2 pin server pod to node
#
{% if workload_args.max_node is defined %}
      nodeSelector:
        #kubernetes.io/hostname: '{{ item[0] }}'
        kubernetes.io/hostname: '{{ worker_node_list[item[0]] }}'
{% endif %}

{% if workload_args.serviceip is sameas true %}
      securityContext:
        sysctls:
        - name: net.ipv4.ip_local_port_range
          value: 20000 20011
{% endif %}
{% include "metadata.yml.j2" %}
