kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: "{{ meta.name }}-networkpolicy-{{ trunc_uuid }}"
  namespace: '{{ operator_namespace }}'
spec:
  podSelector:
    matchLabels:
      type: "{{ meta.name }}-bench-server-{{ trunc_uuid }}"
  ingress:
  - from:
    - podSelector:
        matchLabels:
          type: "{{ meta.name }}-bench-client-{{ trunc_uuid }}"
    - namespaceSelector:
        matchLabels:
          project: "{{ operator_namespace }}"
{% if workload.args.ip_block.enable | default(false) %}
    - ipBlock:
        cidr: "{{ workload.args.ip_block.allow_subnet }}"
        except:
{% for subnet in workload.args.ip_block.except_subnet %}
        - "{{ subnet }}"
{% endfor %}
{% if workload.args.port_block.enable | default(false) %}
    ports:
    - protocol: TCP
      port: 6379
{% for prange in workload.args.port_block.range %}
{% for num in range(prange[0]|int,prange[1]|int) %}
    - protocol: TCP
      port: {{ num }}
    - protocol: UDP
      port: {{ num }}
{% endfor %}
{% endfor %}
{% endif %}
  egress:
  - to:
    - ipBlock:
        cidr: "{{ workload.args.ip_block.allow_subnet }}"
{% if workload.args.port_block.enable | default(false) %}
    ports:
{% for prange in workload.args.port_block.range %}
{% for num in range(prange[0]|int,prange[1]|int) %}
    - protocol: TCP
      port: {{ num }}
    - protocol: UDP
      port: {{ num }}
{% endfor %}
{% endfor %}
{% endif %}
{% endif %}

